# Smart UI Refresh Optimization

## Проблема
UI перерисовывался каждую минуту при автообновлении MODX API, даже при отсутствии реальных изменений в данных, что вызывало неприятные мерцания интерфейса.

## Решение
Реализована умная система сравнения критических параметров продуктов и категорий, которая обновляет UI только при реальных изменениях.

## Изменения в `script.js`

### 1. Улучшенная функция `checkProductsDataChanges()`
- **Добавлены все критические параметры:**
  - `id` - ID продукта
  - `menuindex` - Порядок в меню
  - `pagetitle` - Название продукта
  - `template` - Шаблон
  - `published` - Статус публикации
  - `parent_id` - Родительская категория
  - `price` - Цена
  - `weight` - Вес
  - `source` - Источник
  - `image` - Главное изображение
  - `images` - Все изображения
  - `product_description` - Описание
  - `product_days_order` - Дни заказа
  - `product_structure` - Состав/ингредиенты
  - `product_calories` - Калории
  - `product_bgu` - БЖУ
  - `product_vegan` - Веганский статус

- **Глубокое сравнение массивов** (например, для `images`)
- **Детальное логирование** изменений для отладки

### 2. Новая функция `checkCategoriesDataChanges()`
- **Проверяет критические параметры категорий:**
  - `id` - ID категории
  - `name` - Название категории
  - `description` - Описание категории
  - `uri` - URI категории
  - `image` - Изображение категории
  - `key` - Ключ категории
  - `menuindex` - Порядок в меню

### 3. Новая функция `fetchCategoriesData()`
- **Отдельная функция** для загрузки данных категорий
- **Переиспользование** в автообновлении и обычной загрузке
- **Обработка ошибок** и возврат null при неудаче

### 4. Оптимизированная логика обновления UI
- **Умное обновление экранов:**
  - Продукты: только при изменении данных продуктов
  - Категории: только при изменении данных категорий
  - Корзина: только при изменении цен/доступности

- **Защита от множественных обновлений:**
  - Флаг `isUpdatingUI` предотвращает одновременные обновления
  - Автоматический сброс флага при завершении или ошибке

### 5. Убрано некритическое логирование
- **Удалены** все детальные сообщения о сравнении
- **Оставлены** только критические предупреждения об ошибках

## Результат
- ✅ MODX API продолжает работать каждые 60 секунд в фоне
- ✅ UI обновляется только при реальных изменениях критических параметров продуктов И категорий
- ✅ Устранены ненужные перерисовки и мерцания
- ✅ Улучшена производительность и пользовательский опыт
- ✅ Сохранена вся существующая функциональность
- ✅ Убрано некритическое логирование

## Тестирование
1. Дождитесь автообновления (каждую минуту)
2. Проверьте, что UI обновляется только при реальных изменениях
3. Убедитесь, что все функции работают корректно
4. Проверьте работу как для продуктов, так и для категорий

## Критические логи (только ошибки)
- `Error comparing products data:` - ошибка сравнения продуктов
- `Error comparing categories data:` - ошибка сравнения категорий
- `Auto-refresh failed:` - ошибка автообновления
- `Failed to load products/categories data:` - ошибка загрузки данных
